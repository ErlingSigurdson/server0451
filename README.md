# Концепция
Простой TCP-сервер (программа) для Linux, который:
- по запросу клиента-подписчика направляет ему заготовленную команду на включение или выключение нагрузки
(в соответствии с текущим предписываемым состоянием нагрузки, информация о котором хранится на сервере).
- по команде клиента-постера меняет заготовленную для клиента-подписчика команду (меняет текущее предписываемое
состояние нагрузки).

Клиентами могут быть любые устройства, способные к коммуникации по TCP/IP, но роль клиента-подписчика предполагается
в первую очередь для устройств IoT, например, модулей ESP8266 или ESP32 с прошивкой типа
[Билли](https://github.com/ErlingSigurdson/Billy_the_Relay).

Текущее предписываемое состояние нагрузки и синтаксис команд (запрос клиента-подписчика тоже считается командой)
хранятся в настроечном файле (имя по умолчанию - `config_server0451`). Администратор сервера может менять синтаксис
команд по своему усмотрению путём редактирования настроечного файла.

Сервер может работать как в локальной, так и в глобальной сети - лишь бы был индивидуальный IP-адрес, по которому
к серверу можно обратиться.

# Инструкция
### Компиляция
Зайдите в директорию `/server0451/src` и запустите команду `make`. Исполняемый файл программы появится в директории
`/server0451/bin`.

### Быстрый запуск
Запустите bash-скрипт `loop_script_server0451.sh`, файл с которым расположен в директории `/server0451/sh`.
Файл скрипта должен быть исполняемым. Если это не так, вызовите `chmod +x loop_script_server0451.sh`.
Скрипт циклически запускает сразу два экземпляра программы, по умолчанию используя порт 80 для первого
и 451 для второго. Первый порт используется для направления серверу команд, второй - для направления серверу запросов.
При необходимости вы можете отредактировать скрипт, например, изменить номера портов или опции командной строки.
Если вы хотите, чтобы сервер продолжил работать после завершения текущей сессии работы с оболочкой операционной
системы, рекомендуется запускать скрипт с помощью утилиты `nohup` (но это не обязательно).

Bash-скрипт `oneshot_script_server0451` работает аналогичным образом, но запускает экземпляры программы единожды,
а не циклически. Скрипт предназначен для отладки и знакомства с работой сервера.

### Команда запуска
Если разбираться более детально, то общий вид команды запуска сервера следующий:
```
sudo execute_server0451 -p <номер_порта> -f <имя_настроечного_файла> [-h][-v][-V] 
```
Опции `-p` и `-f` являются обязательными. Необязательные опции модифицируют поведение программы: 
- `-h` - выводит страницу с подсказками по использованию программы.
- `-v` - включает вывод в консоль информации о текущих действиях сервера, о принятых и переданных сообщениях.
- `-V` - аналогично предыдущему, но дополнительно выводит информацию об установке параметров сокетов.

### Настроечный файл
Как уже было упомянуто, у настроечного файла двойное назначение: он хранит текущее предписываемое состояние нагрузки
и задаёт синтаксис команд. Настроечный файл хранится в директории `/server0451/bin`, вместе с исполняемым файлом
программы. Если файл с заданным в опции `-f` именем отсутствует в этой директории, то программа создаст его
автоматически, указав значения по умолчанию (см. файл `cmd.h`).

### Протоколы
Сервер принимает от клиента-постера как простые строки (последовательности байт), направляемые по TCP
без использования протоколов более высоких уровней OSI (например, с помощью `netcat` или приложения для Android
[Serial Wi-Fi terminal](https://serial-wifi-terminal.en.softonic.com/android)), так и HTTP-запросы. Программа
автоматически определит, что поступивший пакет является HTTP-запросом, и выдаст соответствующий протоколу HTTP ответ.
Управлять сервером через HTTP можно методами GET (указывая соответствующий синтаксису команд URI) и POST (указывая
в теле запроса соответствующую синтаксису команд пару параметр+значение).

### Управление несколькими устройствами
Никаких проблем, к серверу могут обращаться несколько клиентов-подписчиков. Если все они должны получать одинаковую
команду (синхронно включать и выключать нагрузку), то никаких дополнительных действий не требуется. Если есть два
и более устройства, которые должны получать разные команды, то следует запустить `loop_script_server0451.sh`
соответствующее количество раз, при этом каждый раз задавая разное имя настроечного файла. После этого следует
отредактировать настроечные файлы таким образом, чтобы указанный в них синтаксис команд хотя бы немного различался
от файла к файлу.

### Известные проблемы
На некоторых системах вызов команды `lsof`, производимый скриптом `loop_script_server0451.sh`, может вызывать
предупреждение типа "can't stat() fuse.gvfsd-fuse file system". Предупреждение не влияет на работу сервера,
но при желании можно исключить причину его появления, отредактировав скрипт. Для этого добавьте к вызову
`lsof` ключ `-e` с аргументом, соответствующим имени файловой системы, к которой `lsof` не удалось обратиться.
Полное имя файловой системы отображается в тексте предупреждения и обычно имеет вид "/run/user/1000/gvfs" или
"/run/user/1000/doc". Или, как вариант, можно просто добавить к вызову `lsof` опцию `-w`, подавляющую вывод
предупреждений.

# Справедливые вопросы
### Почему "0451"?
[Отсылка](https://deusex.fandom.com/wiki/0451) к серии видеоигр "Deus Ex".

### Почему не MQTT?
Не так интересно. Используя такую простую программу как server0451, можно в деталях пощупать, что происходит
на сервере (устройстве) и как программа взаимодействует с файлами.  

### Зачем нужен скрипт оболочки? Нельзя ли было сделать так, чтобы программа продолжительно работала сама по себе?
Может, и можно, но с помощью команд оболочки проще удостовериться, что порт освободился после приёма
или передачи очередного сообщения.

### Что с безопасностью?
Это не то программное обеспечение, которое предназначено для выполнения ответственных задач, но если вы зададите
в настроечном файле уникальный синтаксис команд, то вашим сервером точно нельзя будет сходу начать управлять,
направляя рандомные команды.

# Note for English speakers
Please note that `help page` is written in English. Run executable with `-h` option to read it or refer to
[help_page.h](https://github.com/ErlingSigurdson/server0451/blob/main/src/help_page.h).
